# ADR-001: Implement Comprehensive Testing Strategy

## Context

The Music Tracks App currently has minimal test coverage, with only basic spec files generated by Angular CLI. The project structure follows a clean, modular architecture with feature-based organization, but lacks comprehensive testing to ensure reliability and maintainability as the codebase grows.

Current testing situation:

- Only default Angular spec files exist (\*.spec.ts)
- No integration tests
- No E2E tests
- No testing utilities or helpers
- No test data factories
- No visual regression testing
- Using default Karma/Jasmine setup which is slower and less feature-rich

This lack of testing creates several risks:

- Difficulty in refactoring code safely
- Higher probability of introducing regressions
- Increased time for manual testing
- Lower developer confidence when making changes
- Harder onboarding for new team members

## Decision

We will implement a comprehensive testing strategy by installing and configuring multiple testing tools and frameworks.

First, we will replace the default Karma/Jasmine test runner with Jest for better performance and developer experience:

```bash
npm uninstall karma karma-chrome-launcher karma-coverage karma-jasmine karma-jasmine-html-reporter
npm install --save-dev jest @types/jest jest-preset-angular @angular-builders/jest
```

We will configure Jest in `jest.config.js`:

```javascript
module.exports = {
  preset: 'jest-preset-angular',
  setupFilesAfterEnv: ['<rootDir>/setup-jest.ts'],
  testPathIgnorePatterns: ['/node_modules/', '/dist/'],
  collectCoverageFrom: ['src/app/**/*.ts', '!src/app/**/*.spec.ts', '!src/app/**/index.ts'],
};
```

Then, we will enhance our testing capabilities by installing `@faker-js/faker` for test data generation and `jest-marbles` for RxJS testing:

```bash
npm install --save-dev @faker-js/faker jest-marbles
```

For E2E testing, we will install Cypress along with Percy for visual regression testing:

```bash
npm install --save-dev cypress @percy/cypress
```

We will create a testing utilities directory structure:

```
src/
└── testing/
    ├── factories/
    │   ├── track.factory.ts
    │   └── genre.factory.ts
    ├── mocks/
    │   └── api.mock.ts
    └── helpers/
        └── test-helpers.ts
```

The implementation will follow this timeline:

- **Week 1**: Set up testing infrastructure (Jest migration, Cypress, coverage tools, CI/CD integration)
- **Week 2**: Create testing utilities and factories, write unit tests for services
- **Week 3**: Implement integration tests and E2E tests for critical paths
- **Ongoing**: Maintain 80% coverage for new code, refactor existing tests as needed

Example of test factory implementation:

```typescript
// src/testing/factories/track.factory.ts
export class TrackFactory {
  static build(overrides?: Partial<Track>): Track {
    return {
      id: faker.datatype.uuid(),
      title: faker.music.songName(),
      artist: faker.name.fullName(),
      album: faker.lorem.words(2),
      genres: [faker.music.genre()],
      slug: faker.helpers.slugify(faker.music.songName()),
      createdAt: faker.date.past().toISOString(),
      updatedAt: faker.date.recent().toISOString(),
      ...overrides,
    };
  }
}
```

## Rationale

Comprehensive testing helps to:

- Increase code maintainability by catching issues early
- Enable safe refactoring with confidence
- Reduce manual testing time
- Improve developer productivity
- Document expected behavior through test cases
- Ensure critical features (audio playback, CRUD operations) work reliably

Jest specifically provides:

- Faster test execution compared to Karma
- Better error messages and stack traces
- Built-in code coverage without additional configuration
- Snapshot testing capabilities
- Better watch mode for development

## Status

**Proposed**

## Consequences

**Positive:**

- More maintainable and reliable codebase
- Faster bug detection and resolution
- Living documentation through test cases
- Reduced regression bugs
- Higher developer confidence when making changes
- Better onboarding experience for new team members
- Automated quality assurance in CI/CD pipeline
- Faster test execution with Jest (2-3x faster than Karma)
- Better developer experience with Jest's watch mode and error messages

**Negative:**

- Initial setup time of 2-3 weeks
- Increased CI/CD pipeline duration (+5-10 minutes)
- Learning curve for team members unfamiliar with testing tools
- Migration effort from Karma/Jasmine to Jest
- Ongoing maintenance of test suite
- Additional dependencies to manage
- Potential for flaky tests causing false failures
- Initial slowdown in feature development velocity

## References

- [Angular Testing Guide](https://angular.io/guide/testing)
- [Jest Documentation](https://jestjs.io/)
- [jest-preset-angular](https://github.com/thymikee/jest-preset-angular)
- [Cypress Best Practices](https://docs.cypress.io/guides/references/best-practices)
- [Testing RxJS Code with Jest Marbles](https://github.com/just-jeb/jest-marbles)
